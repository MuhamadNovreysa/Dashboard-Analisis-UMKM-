<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Segmentation Dashboard - UMKM Digital</title>
    <script src="https://unpkg.com/@tailwindcss/browser@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/lucide@0.469.0/dist/umd/lucide.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/recharts@2.15.0/umd/Recharts.min.js"></script>
    <style>
        :root {
            --background: 222.2 84% 4.9%;
            --foreground: 210 40% 98%;
            --card: 222.2 84% 4.9%;
            --card-foreground: 210 40% 98%;
            --popover: 222.2 84% 4.9%;
            --popover-foreground: 210 40% 98%;
            --primary: 217.2 91.2% 59.8%;
            --primary-foreground: 222.2 47.4% 11.2%;
            --secondary: 217.2 32.6% 17.5%;
            --secondary-foreground: 210 40% 98%;
            --muted: 217.2 32.6% 17.5%;
            --muted-foreground: 215 20.2% 65.1%;
            --accent: 217.2 32.6% 17.5%;
            --accent-foreground: 210 40% 98%;
            --destructive: 0 62.8% 30.6%;
            --destructive-foreground: 210 40% 98%;
            --border: 217.2 32.6% 17.5%;
            --input: 217.2 32.6% 17.5%;
            --ring: 224.3 76.3% 48%;
            --radius: 0.5rem;
            --chart-1: 221.2 83.2% 53.3%;
            --chart-2: 212 95% 68%;
            --chart-3: 216 92% 60%;
            --chart-4: 210 98% 78%;
            --chart-5: 212 97% 87%;
        }

        body {
            background-color: hsl(var(--background));
            color: hsl(var(--foreground));
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }

        .glass-panel {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius);
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
    </style>
</head>
<body class="min-h-screen custom-scrollbar">
    <!-- Header -->
    <header class="sticky top-0 z-50 w-full border-b bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60">
        <div class="container mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <div class="bg-primary p-1.5 rounded-lg">
                    <i data-lucide="layout-dashboard" class="w-5 h-5 text-primary-foreground"></i>
                </div>
                <h1 class="font-bold text-xl tracking-tight">Caung Segmentation</h1>
            </div>
            <div class="flex items-center gap-4">
                <select id="date-range" class="bg-secondary text-sm rounded-md px-3 py-1.5 border border-border focus:ring-2 focus:ring-ring outline-none">
                    <option value="24h">24 Jam Terakhir</option>
                    <option value="7d">7 Hari Terakhir</option>
                    <option value="30d" selected>30 Hari Terakhir</option>
                    <option value="all">Semua Data</option>
                </select>
                <button id="upload-btn" class="bg-primary text-primary-foreground text-sm font-medium px-4 py-1.5 rounded-md hover:opacity-90 transition-opacity flex items-center gap-2">
                    <i data-lucide="upload" class="w-4 h-4"></i>
                    Upload Data
                </button>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8 space-y-8">
        <!-- Metrics Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <div class="glass-panel p-6 space-y-2">
                <div class="flex items-center justify-between">
                    <p class="text-sm font-medium text-muted-foreground">Total Pelanggan</p>
                    <i data-lucide="users" class="w-4 h-4 text-muted-foreground"></i>
                </div>
                <div class="flex flex-col">
                    <h3 class="text-2xl font-bold" id="total-customers">0</h3>
                    <span class="text-xs text-emerald-500 font-medium flex items-center gap-1">
                        <i data-lucide="trending-up" class="w-3 h-3"></i> +12% dari bln lalu
                    </span>
                </div>
            </div>
            <div class="glass-panel p-6 space-y-2">
                <div class="flex items-center justify-between">
                    <p class="text-sm font-medium text-muted-foreground">Transaksi Bulan Ini</p>
                    <i data-lucide="credit-card" class="w-4 h-4 text-muted-foreground"></i>
                </div>
                <div class="flex flex-col">
                    <h3 class="text-2xl font-bold" id="total-transactions">0</h3>
                    <span class="text-xs text-emerald-500 font-medium flex items-center gap-1">
                        <i data-lucide="trending-up" class="w-3 h-3"></i> +8% dari bln lalu
                    </span>
                </div>
            </div>
            <div class="glass-panel p-6 space-y-2">
                <div class="flex items-center justify-between">
                    <p class="text-sm font-medium text-muted-foreground">Revenue</p>
                    <i data-lucide="dollar-sign" class="w-4 h-4 text-muted-foreground"></i>
                </div>
                <div class="flex flex-col">
                    <h3 class="text-2xl font-bold" id="total-revenue">Rp 0</h3>
                    <span class="text-xs text-emerald-500 font-medium flex items-center gap-1">
                        <i data-lucide="trending-up" class="w-3 h-3"></i> +15% dari bln lalu
                    </span>
                </div>
            </div>
            <div class="glass-panel p-6 space-y-2">
                <div class="flex items-center justify-between">
                    <p class="text-sm font-medium text-muted-foreground">Conversion Rate</p>
                    <i data-lucide="activity" class="w-4 h-4 text-muted-foreground"></i>
                </div>
                <div class="flex flex-col">
                    <h3 class="text-2xl font-bold" id="avg-conversion">0%</h3>
                    <span class="text-xs text-rose-500 font-medium flex items-center gap-1">
                        <i data-lucide="trending-down" class="w-3 h-3"></i> -2% dari bln lalu
                    </span>
                </div>
            </div>
        </div>

        <!-- Charts Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="glass-panel p-6 flex flex-col min-h-[400px]">
                <div class="mb-4">
                    <h3 class="text-lg font-semibold">K-Means Customer Segmentation</h3>
                    <p class="text-sm text-muted-foreground">Pengelompokan customer berdasarkan perilaku belanja</p>
                </div>
                <div id="clustering-chart" class="flex-grow w-full h-[300px]"></div>
            </div>
            <div class="glass-panel p-6 flex flex-col min-h-[400px]">
                <div class="mb-4">
                    <h3 class="text-lg font-semibold">Kinerja UMKM</h3>
                    <p class="text-sm text-muted-foreground">Tren revenue dan transaksi harian</p>
                </div>
                <div id="performance-chart" class="flex-grow w-full h-[300px]"></div>
            </div>
        </div>

        <!-- AI Insights -->
        <div class="glass-panel overflow-hidden border-primary/20">
            <div class="bg-primary/5 p-6 border-b border-border flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="bg-primary/20 p-2 rounded-full">
                        <i data-lucide="sparkles" class="w-5 h-5 text-primary"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold">Caung AI Insights</h3>
                        <p class="text-xs text-muted-foreground">Analisis cerdas berdasarkan data aktual UMKM Anda</p>
                    </div>
                </div>
                <button id="consult-btn" class="bg-primary text-primary-foreground text-sm font-bold px-6 py-2 rounded-full hover:scale-105 transition-transform flex items-center gap-2">
                    Konsultasi Sekarang
                </button>
            </div>
            <div class="p-6 grid grid-cols-1 md:grid-cols-3 gap-6" id="ai-summary">
                <div class="space-y-2">
                    <h4 class="text-sm font-bold text-primary flex items-center gap-2">
                        <i data-lucide="target" class="w-4 h-4"></i> Executive Summary
                    </h4>
                    <p class="text-sm text-muted-foreground leading-relaxed" id="ai-exec-summary">Silakan upload data untuk melihat analisis AI.</p>
                </div>
                <div class="space-y-2">
                    <h4 class="text-sm font-bold text-amber-500 flex items-center gap-2">
                        <i data-lucide="lightbulb" class="w-4 h-4"></i> Peluang Strategis
                    </h4>
                    <p class="text-sm text-muted-foreground leading-relaxed" id="ai-opportunities">Kami akan memberikan rekomendasi aksi setelah data diolah.</p>
                </div>
                <div class="space-y-2">
                    <h4 class="text-sm font-bold text-emerald-500 flex items-center gap-2">
                        <i data-lucide="check-circle" class="w-4 h-4"></i> Rekomendasi Aksi
                    </h4>
                    <ul class="text-sm text-muted-foreground space-y-1 list-disc list-inside" id="ai-actions">
                        <li>Upload file CSV/Excel Anda.</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Segment Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4" id="segment-cards">
            <!-- Dynamically populated -->
        </div>

        <!-- Details List -->
        <div class="glass-panel overflow-hidden">
            <div class="p-6 border-b flex items-center justify-between">
                <div>
                    <h3 class="text-lg font-bold">Daftar Customer Keseluruhan</h3>
                    <p class="text-sm text-muted-foreground">Monitoring riwayat dan profil customer</p>
                </div>
                <div class="flex items-center gap-2">
                    <select id="sort-by" class="bg-secondary text-xs rounded-md px-3 py-1.5 border border-border outline-none">
                        <option value="amount">Urutkan: Transaksi Terbesar</option>
                        <option value="frequency">Urutkan: Paling Sering</option>
                        <option value="date">Urutkan: Tanggal Terbaru</option>
                        <option value="name">Urutkan: Nama (A-Z)</option>
                    </select>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left">
                    <thead class="bg-muted/50 text-muted-foreground font-medium border-b">
                        <tr>
                            <th class="px-6 py-4">Customer</th>
                            <th class="px-6 py-4">Kontak</th>
                            <th class="px-6 py-4">Segmen</th>
                            <th class="px-6 py-4 text-right">Total Transaksi</th>
                            <th class="px-6 py-4 text-right">Frekuensi</th>
                            <th class="px-6 py-4">Terakhir Belanja</th>
                        </tr>
                    </thead>
                    <tbody id="customer-table-body" class="divide-y border-border">
                        <!-- Dynamically populated -->
                    </tbody>
                </table>
            </div>
            <div class="p-4 border-t flex items-center justify-between">
                <p class="text-xs text-muted-foreground" id="table-pagination-info">Menampilkan 0 dari 0 customer</p>
                <div class="flex gap-2">
                    <button class="px-3 py-1 rounded bg-secondary text-xs disabled:opacity-50" id="prev-page">Previous</button>
                    <button class="px-3 py-1 rounded bg-secondary text-xs disabled:opacity-50" id="next-page">Next</button>
                </div>
            </div>
        </div>
    </main>

    <!-- Upload Modal -->
    <div id="modal-overlay" class="fixed inset-0 bg-black/80 z-[100] hidden items-center justify-center p-4">
        <div class="glass-panel w-full max-w-md p-6 space-y-6">
            <div class="flex items-center justify-between">
                <h3 class="text-xl font-bold">Upload Data UMKM</h3>
                <button id="close-modal" class="p-1 hover:bg-white/10 rounded-full transition-colors">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div class="border-2 border-dashed border-border rounded-xl p-10 flex flex-col items-center justify-center space-y-4 hover:border-primary/50 transition-colors cursor-pointer" id="drop-zone">
                <div class="bg-primary/10 p-4 rounded-full">
                    <i data-lucide="file-spreadsheet" class="w-10 h-10 text-primary"></i>
                </div>
                <div class="text-center">
                    <p class="font-bold">Pilih file atau seret ke sini</p>
                    <p class="text-xs text-muted-foreground">Format yang didukung: CSV, XLS, XLSX</p>
                </div>
                <input type="file" id="file-input" class="hidden" accept=".csv,.xlsx,.xls">
                <button class="bg-secondary text-sm px-4 py-2 rounded-lg border border-border">Pilih File</button>
            </div>
            <div class="bg-blue-500/10 border border-blue-500/20 p-4 rounded-lg flex gap-3">
                <i data-lucide="info" class="w-5 h-5 text-blue-500 shrink-0"></i>
                <div class="text-xs space-y-1">
                    <p class="font-bold text-blue-400">Tips Penting</p>
                    <p class="text-blue-300/80">Pastikan file Anda memiliki kolom: customer_name, transaction_date, dan transaction_amount.</p>
                </div>
            </div>
            <div class="flex gap-3">
                <button id="delete-all-btn" class="flex-1 bg-rose-500/20 text-rose-500 hover:bg-rose-500/30 text-sm font-bold py-3 rounded-xl transition-all border border-rose-500/30">Hapus Data</button>
                <button id="process-btn" class="flex-1 bg-primary text-primary-foreground hover:opacity-90 text-sm font-bold py-3 rounded-xl transition-all shadow-lg shadow-primary/20">Proses Sekarang</button>
            </div>
        </div>
    </div>

    <!-- Chat Modal -->
    <div id="chat-overlay" class="fixed inset-0 bg-black/80 z-[100] hidden items-center justify-center p-4">
        <div class="glass-panel w-full max-w-lg h-[600px] flex flex-col overflow-hidden">
            <div class="p-4 border-b bg-primary/10 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-primary flex items-center justify-center">
                        <i data-lucide="bot" class="w-6 h-6 text-primary-foreground"></i>
                    </div>
                    <div>
                        <h3 class="font-bold">Caung Consultant</h3>
                        <p class="text-[10px] text-primary">Tanyain apa aja gw jawab</p>
                    </div>
                </div>
                <button id="close-chat" class="p-1 hover:bg-white/10 rounded-full transition-colors">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div id="chat-messages" class="flex-grow p-4 overflow-y-auto space-y-4 custom-scrollbar">
                <div class="bg-secondary/50 p-3 rounded-lg text-sm max-w-[85%] self-start">
                    Halo! Gw Caung Consultant. Ada yang mau ditanyain soal data UMKM lo? Gw siap bantu analisa segmen customer atau strategi marketing biar cuan makin luber!
                </div>
            </div>
            <div class="p-4 border-t bg-background/50">
                <form id="chat-form" class="flex gap-2">
                    <input type="text" id="chat-input" placeholder="Tanyain strategi buat High Value customer..." class="flex-grow bg-secondary border border-border rounded-lg px-4 py-2 text-sm outline-none focus:ring-2 focus:ring-ring">
                    <button type="submit" class="bg-primary text-primary-foreground p-2 rounded-lg hover:opacity-90">
                        <i data-lucide="send" class="w-5 h-5"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Data Store Logic
        const state = {
            allData: [],
            filteredData: [],
            currentPage: 1,
            itemsPerPage: 10,
            currentSort: 'amount',
            dateFilter: '30d',
            segments: {
                'High Value': { color: 'hsl(var(--chart-1))', label: 'Loyal & Big Spender', icon: 'crown' },
                'Medium Value': { color: 'hsl(var(--chart-2))', label: 'Potensial Meningkat', icon: 'trending-up' },
                'Low Value': { color: 'hsl(var(--chart-3))', label: 'Butuh Perhatian', icon: 'alert-circle' },
                'Potential': { color: 'hsl(var(--chart-4))', label: 'Baru & Menjanjikan', icon: 'zap' }
            }
        };

        // Initialize Lucide Icons
        lucide.createIcons();

        // DOM Elements
        const uploadBtn = document.getElementById('upload-btn');
        const modalOverlay = document.getElementById('modal-overlay');
        const closeModal = document.getElementById('close-modal');
        const chatOverlay = document.getElementById('chat-overlay');
        const closeChat = document.getElementById('close-chat');
        const consultBtn = document.getElementById('consult-btn');
        const fileInput = document.getElementById('file-input');
        const dropZone = document.getElementById('drop-zone');
        const processBtn = document.getElementById('process-btn');
        const deleteAllBtn = document.getElementById('delete-all-btn');
        const dateRangeSelect = document.getElementById('date-range');
        const sortBySelect = document.getElementById('sort-by');
        const customerTableBody = document.getElementById('customer-table-body');
        const prevPageBtn = document.getElementById('prev-page');
        const nextPageBtn = document.getElementById('next-page');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const chatMessages = document.getElementById('chat-messages');

        // Modal Handlers
        uploadBtn.onclick = () => modalOverlay.classList.replace('hidden', 'flex');
        closeModal.onclick = () => modalOverlay.classList.replace('flex', 'hidden');
        consultBtn.onclick = () => chatOverlay.classList.replace('hidden', 'flex');
        closeChat.onclick = () => chatOverlay.classList.replace('flex', 'hidden');

        dropZone.onclick = () => fileInput.click();
        dropZone.ondragover = (e) => { e.preventDefault(); dropZone.classList.add('border-primary'); };
        dropZone.ondragleave = () => dropZone.classList.remove('border-primary');
        dropZone.ondrop = (e) => { e.preventDefault(); handleFiles(e.dataTransfer.files); };
        fileInput.onchange = (e) => handleFiles(e.target.files);

        function handleFiles(files) {
            if (files.length > 0) {
                const file = files[0];
                const reader = new FileReader();
                reader.onload = (e) => {
                    const content = e.target.result;
                    processCSV(content);
                };
                reader.readAsText(file);
            }
        }

        function processCSV(csv) {
            const lines = csv.split('\n');
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
                const entry = {};
                headers.forEach((h, idx) => entry[h] = values[idx]);
                
                // Convert values
                entry.transaction_amount = parseFloat(entry.transaction_amount || 0);
                entry.transaction_date = entry.transaction_date || '2025-10-01';
                data.push(entry);
            }

            state.allData = data;
            updateDashboard();
            modalOverlay.classList.replace('flex', 'hidden');
        }

        deleteAllBtn.onclick = () => {
            state.allData = [];
            updateDashboard();
            modalOverlay.classList.replace('flex', 'hidden');
        };

        dateRangeSelect.onchange = (e) => {
            state.dateFilter = e.target.value;
            updateDashboard();
        };

        sortBySelect.onchange = (e) => {
            state.currentSort = e.target.value;
            renderCustomerTable();
        };

        // Data Processing & UI Logic
        function updateDashboard() {
            filterData();
            calculateMetrics();
            renderClusteringChart();
            renderPerformanceChart();
            renderSegmentCards();
            renderAIInsights();
            renderCustomerTable();
        }

        function filterData() {
            const now = new Date('2025-10-04');
            state.filteredData = state.allData.filter(d => {
                if (state.dateFilter === 'all') return true;
                const dDate = new Date(d.transaction_date);
                const diff = (now - dDate) / (1000 * 60 * 60 * 24);
                if (state.dateFilter === '24h') return diff <= 1;
                if (state.dateFilter === '7d') return diff <= 7;
                if (state.dateFilter === '30d') return diff <= 30;
                return true;
            });
        }

        function calculateMetrics() {
            const uniqueCustomers = new Set(state.filteredData.map(d => d.customer_id || d.email)).size;
            const revenue = state.filteredData.reduce((acc, curr) => acc + curr.transaction_amount, 0);
            
            document.getElementById('total-customers').innerText = uniqueCustomers.toLocaleString();
            document.getElementById('total-transactions').innerText = state.filteredData.length.toLocaleString();
            document.getElementById('total-revenue').innerText = 'Rp ' + Math.round(revenue).toLocaleString();
            document.getElementById('avg-conversion').innerText = (uniqueCustomers > 0 ? (state.filteredData.length / uniqueCustomers).toFixed(1) : 0) + '%';
        }

        // Clustering Helper
        function getCustomerAggregation() {
            const agg = {};
            state.filteredData.forEach(d => {
                const id = d.customer_id || d.email;
                if (!agg[id]) {
                    agg[id] = { 
                        name: d.customer_name, 
                        email: d.email, 
                        phone: d.phone, 
                        total: 0, 
                        count: 0, 
                        lastDate: d.transaction_date 
                    };
                }
                agg[id].total += d.transaction_amount;
                agg[id].count += 1;
                if (new Date(d.transaction_date) > new Date(agg[id].lastDate)) {
                    agg[id].lastDate = d.transaction_date;
                }
            });
            return Object.values(agg);
        }

        function assignSegment(customer) {
            const amount = customer.total;
            const freq = customer.count;
            if (amount > 1000000 && freq > 3) return 'High Value';
            if (amount > 500000 || freq > 2) return 'Medium Value';
            if (freq === 1 && amount > 300000) return 'Potential';
            return 'Low Value';
        }

        function renderClusteringChart() {
            const customers = getCustomerAggregation();
            const container = document.getElementById('clustering-chart');
            container.innerHTML = '';
            
            if (customers.length === 0) {
                container.innerHTML = '<div class="h-full flex items-center justify-center text-muted-foreground text-sm">Upload data untuk melihat clustering</div>';
                return;
            }

            // Simple SVG Scatter Plot
            const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
            svg.setAttribute("width", "100%");
            svg.setAttribute("height", "100%");
            svg.setAttribute("viewBox", "0 0 400 300");
            
            const maxAmount = Math.max(...customers.map(c => c.total));
            const maxFreq = Math.max(...customers.map(c => c.count));

            customers.forEach(c => {
                const segment = assignSegment(c);
                const x = (c.total / maxAmount) * 380 + 10;
                const y = 290 - (c.count / maxFreq) * 280;
                
                const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                circle.setAttribute("cx", x);
                circle.setAttribute("cy", y);
                circle.setAttribute("r", "4");
                circle.setAttribute("fill", state.segments[segment].color);
                circle.setAttribute("opacity", "0.7");
                svg.appendChild(circle);
            });

            container.appendChild(svg);
        }

        function renderPerformanceChart() {
            const container = document.getElementById('performance-chart');
            container.innerHTML = '';
            
            if (state.filteredData.length === 0) {
                container.innerHTML = '<div class="h-full flex items-center justify-center text-muted-foreground text-sm">Upload data untuk melihat tren</div>';
                return;
            }

            // Group by date
            const grouped = {};
            state.filteredData.forEach(d => {
                const date = d.transaction_date.split('T')[0];
                grouped[date] = (grouped[date] || 0) + d.transaction_amount;
            });

            const sortedDates = Object.keys(grouped).sort();
            const maxVal = Math.max(...Object.values(grouped));

            const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
            svg.setAttribute("width", "100%");
            svg.setAttribute("height", "100%");
            svg.setAttribute("viewBox", "0 0 400 300");

            let pathD = `M 0 300`;
            sortedDates.forEach((date, i) => {
                const x = (i / (sortedDates.length - 1)) * 400;
                const y = 300 - (grouped[date] / maxVal) * 280;
                pathD += ` L ${x} ${y}`;
            });
            pathD += ` L 400 300 Z`;

            const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
            path.setAttribute("d", pathD);
            path.setAttribute("fill", "url(#chartGradient)");
            path.setAttribute("opacity", "0.3");
            
            const linePath = pathD.replace(/ Z$/, "").replace(/^M 0 300 L/, "M");
            const line = document.createElementNS("http://www.w3.org/2000/svg", "path");
            line.setAttribute("d", linePath);
            line.setAttribute("stroke", "hsl(var(--primary))");
            line.setAttribute("stroke-width", "2");
            line.setAttribute("fill", "none");

            const defs = document.createElementNS("http://www.w3.org/2000/svg", "defs");
            defs.innerHTML = `
                <linearGradient id="chartGradient" x1="0" y1="0" x2="0" y2="1">
                    <stop offset="0%" stop-color="hsl(var(--primary))" />
                    <stop offset="100%" stop-color="transparent" />
                </linearGradient>
            `;

            svg.appendChild(defs);
            svg.appendChild(path);
            svg.appendChild(line);
            container.appendChild(svg);
        }

        function renderSegmentCards() {
            const container = document.getElementById('segment-cards');
            container.innerHTML = '';
            const customers = getCustomerAggregation();
            const counts = { 'High Value': 0, 'Medium Value': 0, 'Low Value': 0, 'Potential': 0 };
            
            customers.forEach(c => {
                counts[assignSegment(c)]++;
            });

            Object.entries(state.segments).forEach(([name, config]) => {
                const count = counts[name];
                const card = document.createElement('div');
                card.className = 'glass-panel p-5 space-y-4 hover:border-primary/50 transition-all cursor-pointer group';
                card.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="p-2 rounded-lg" style="background: ${config.color}20">
                            <i data-lucide="${config.icon}" class="w-5 h-5" style="color: ${config.color}"></i>
                        </div>
                        <span class="text-xs font-bold px-2 py-0.5 rounded-full bg-white/5 text-muted-foreground">${Math.round(count/customers.length*100 || 0)}%</span>
                    </div>
                    <div>
                        <h4 class="font-bold text-sm">${name}</h4>
                        <p class="text-[10px] text-muted-foreground">${config.label}</p>
                    </div>
                    <div class="flex items-end justify-between pt-2">
                        <h3 class="text-xl font-bold">${count} <span class="text-[10px] font-normal text-muted-foreground">Customers</span></h3>
                        <button class="text-[10px] font-bold text-primary group-hover:underline">Lihat Detail</button>
                    </div>
                `;
                container.appendChild(card);
            });
            lucide.createIcons();
        }

        function renderAIInsights() {
            const customers = getCustomerAggregation();
            if (customers.length === 0) return;

            const counts = { 'High Value': 0, 'Medium Value': 0, 'Low Value': 0, 'Potential': 0 };
            customers.forEach(c => counts[assignSegment(c)]++);

            document.getElementById('ai-exec-summary').innerText = `Ditemukan ${customers.length} customer aktif. Segmen '${Object.keys(counts).reduce((a, b) => counts[a] > counts[b] ? a : b)}' mendominasi pasar Anda dengan ${Math.max(...Object.values(counts))} pelanggan.`;
            document.getElementById('ai-opportunities').innerText = `Segmen 'Potential' menunjukkan peluang Upselling. Fokus pada ${counts['Potential']} pelanggan di segmen ini untuk meningkatkan CLV.`;
            document.getElementById('ai-actions').innerHTML = `
                <li>Kirim promo loyalty reward ke ${counts['High Value']} High Value customers.</li>
                <li>Lakukan re-engagement campaign untuk segmen Low Value.</li>
                <li>Tingkatkan limit atau fasilitas untuk Medium Value agar naik ke High Value.</li>
            `;
        }

        function renderCustomerTable() {
            const customers = getCustomerAggregation();
            
            // Sort
            customers.sort((a, b) => {
                if (state.currentSort === 'amount') return b.total - a.total;
                if (state.currentSort === 'frequency') return b.count - a.count;
                if (state.currentSort === 'date') return new Date(b.lastDate) - new Date(a.lastDate);
                if (state.currentSort === 'name') return a.name.localeCompare(b.name);
                return 0;
            });

            // Paginate
            const start = (state.currentPage - 1) * state.itemsPerPage;
            const end = start + state.itemsPerPage;
            const paginated = customers.slice(start, end);

            customerTableBody.innerHTML = '';
            paginated.forEach(c => {
                const seg = assignSegment(c);
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center text-[10px] font-bold text-primary">
                                ${c.name.split(' ').map(n => n[0]).join('')}
                            </div>
                            <span class="font-bold">${c.name}</span>
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex flex-col">
                            <span class="text-xs">${c.email}</span>
                            <span class="text-[10px] text-muted-foreground">${c.phone}</span>
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <span class="text-[10px] px-2 py-0.5 rounded-full border" style="border-color: ${state.segments[seg].color}50; color: ${state.segments[seg].color}">
                            ${seg}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-right font-mono">Rp ${Math.round(c.total).toLocaleString()}</td>
                    <td class="px-6 py-4 text-right">${c.count}x</td>
                    <td class="px-6 py-4 text-xs text-muted-foreground">${c.lastDate}</td>
                `;
                customerTableBody.appendChild(tr);
            });

            document.getElementById('table-pagination-info').innerText = `Menampilkan ${start + 1}-${Math.min(end, customers.length)} dari ${customers.length} customer`;
            prevPageBtn.disabled = state.currentPage === 1;
            nextPageBtn.disabled = end >= customers.length;
        }

        prevPageBtn.onclick = () => { if (state.currentPage > 1) { state.currentPage--; renderCustomerTable(); } };
        nextPageBtn.onclick = () => { if (state.currentPage * state.itemsPerPage < getCustomerAggregation().length) { state.currentPage++; renderCustomerTable(); } };

        // Chatbot Logic
        chatForm.onsubmit = (e) => {
            e.preventDefault();
            const msg = chatInput.value.trim();
            if (!msg) return;

            // Add user message
            const userDiv = document.createElement('div');
            userDiv.className = 'bg-primary text-primary-foreground p-3 rounded-lg text-sm max-w-[85%] self-end ml-auto';
            userDiv.innerText = msg;
            chatMessages.appendChild(userDiv);
            chatInput.value = '';

            // Loading state
            const botDiv = document.createElement('div');
            botDiv.className = 'bg-secondary/50 p-3 rounded-lg text-sm max-w-[85%] self-start';
            botDiv.innerHTML = '<div class="flex gap-1"><div class="w-1 h-1 bg-primary rounded-full animate-bounce"></div><div class="w-1 h-1 bg-primary rounded-full animate-bounce delay-100"></div><div class="w-1 h-1 bg-primary rounded-full animate-bounce delay-200"></div></div>';
            chatMessages.appendChild(botDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            // Fake AI Logic
            setTimeout(() => {
                const customers = getCustomerAggregation();
                let response = "Hmm, gw butuh data buat analisa nih. Upload dulu gih file CSV lo!";
                
                if (customers.length > 0) {
                    if (msg.toLowerCase().includes('high value')) {
                        response = "Buat segmen High Value, saran gw kasih program loyalitas eksklusif. Mereka udah kontribusi gede, jangan sampe pindah ke kompetitor! Kasih free shipping atau early access ke produk baru.";
                    } else if (msg.toLowerCase().includes('strategi') || msg.toLowerCase().includes('marketing')) {
                        response = "Strategi paling pas: Fokus ke segmen Potential buat naikin frekuensi belanjanya. Kasih diskon buat pembelian kedua dalam 7 hari. Buat segmen Low Value, coba email marketing promo cuci gudang.";
                    } else {
                        response = `Berdasarkan data lo, ada ${customers.length} customer. Performa paling oke ada di tanggal-tanggal gajian. Mau gw detailin per segmen?`;
                    }
                }
                botDiv.innerText = response;
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }, 1000);
        };

        // Initial render
        updateDashboard();
    </script>
</body>
</html>
